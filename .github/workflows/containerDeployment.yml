name: CI/CD

on:
  push:
    branches: [ main ]

env:
  DOCKER_USERNAME: ${{ secrets.DOCKER_HUB_NAME }}
  IMAGE_NAME: ${{ secrets.DOCKER_HUB_NAME }}/contactos:latest
  RESOURCE_GROUP: rg-contactos
  ENVIRONMENT_NAME: contactos-env
  
jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    
    env:
      ARM_CLIENT_ID: ${{ secrets.ARM_CLIENT_ID }}
      ARM_CLIENT_SECRET: ${{ secrets.ARM_CLIENT_SECRET }}
      ARM_SUBSCRIPTION_ID: ${{ secrets.ARM_SUBSCRIPTION_ID }}
      ARM_TENANT_ID: ${{ secrets.ARM_TENANT_ID }}
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Azure Login
      uses: Azure/login@v1.4.6
      with:
        creds: ${{ secrets.AZURE_CREDENTIALS }}
    
    - name: Set subscription
      run: az account set --subscription ${{ secrets.ARM_SUBSCRIPTION_ID }}
          
    - name: Install az containerapp extension
      run: |
        az config set extension.use_dynamic_install=yes_without_prompt
        az extension add --name containerapp --upgrade

    - name: Set up Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'

    - name: Install dependencies
      run: npm ci

    - name: Build Docker image
      run: docker build -t ${{ env.IMAGE_NAME }} .

    - name: Login to Docker Hub
      uses: docker/login-action@v2
      with:
        username: ${{ env.DOCKER_USERNAME }}
        password: ${{ secrets.DOCKER_HUB_TOKEN }}

    - name: Push Docker image
      run: docker push ${{ env.IMAGE_NAME }}

    - name: Check if Container App exists
      id: check-app
      run: |
        if az containerapp show --name contactosapi --resource-group ${{ env.RESOURCE_GROUP }} --query name -o tsv 2>/dev/null; then
          echo "app_exists=true" >> $GITHUB_OUTPUT
        else
          echo "app_exists=false" >> $GITHUB_OUTPUT
        fi

    - name: Deploy Container App
      run: |
        if [ "${{ steps.check-app.outputs.app_exists }}" = "true" ]; then
          echo "Updating existing Container App..."
          az containerapp update \
            --name contactosapi \
            --resource-group ${{ env.RESOURCE_GROUP }} \
            --image ${{ env.IMAGE_NAME }}
        else
          echo "Creating new Container App..."
          az containerapp create \
            --name contactosapi \
            --image ${{ env.IMAGE_NAME }} \
            --resource-group ${{ env.RESOURCE_GROUP }} \
            --environment ${{ env.ENVIRONMENT_NAME }} \
            --ingress external \
            --target-port 3000
        fi
